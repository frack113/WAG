// SPDX-FileCopyrightText: 2023 The WAG development team
//
// SPDX-License-Identifier: GPL-3.0-or-later

/*
        File creation Artefact

the magic bytes and NTFS ADS are store a string HEX value.
like 504B0304 or 4D5A.

Path are regex in json so need `\\.` to get a `.`.

if fullpath is empty , it build the path from
env variable and the cmd_path.
"SystemRoot" "Temp\\debug\\.bin" will give "c:\Windows\Temp\debug.bin"

You can use `SET | more` or `Get-ChildItem Env:` to get the list

*/

use crate::windows::file::{create_file, delete_file};
use crate::windows::users::is_administrator;
use base64::engine::{general_purpose, Engine};
use clap::Parser;
use regex_generate::{Generator, DEFAULT_MAX_REPEAT};
use std::{thread, time, time::Duration};

#[derive(Parser)]
pub struct Dropper {
    #[clap(
        short = 'f',
        long,
        required = true,
        help = "Full path filename (regex)"
    )]
    filename: String,
    #[clap(
        short = 'm',
        long,
        required = false,
        default_value = "V2VsY29tZSB0byB0aGUgV0FH",
        help = "MagicBytes name to use with module manual in base64"
    )]
    magicbyte: String,
    #[clap(
        short = 'a',
        long,
        required = false,
        default_value_t = false,
        help = "Need to be admin"
    )]
    admin: bool,
    #[clap(
        short = 'r',
        long,
        required = false,
        default_value_t = false,
        help = "Remove file"
    )]
    remove: bool,
}

impl Dropper {
    pub fn run(&self) -> i32 {
        if self.admin
            && !match is_administrator() {
                Ok(is_admin) => is_admin,
                Err(error) => {
                    println!(
                        "Could not check if the user is an administrator or not.\nError: {}",
                        error
                    );

                    return 1;
                }
            }
        {
            println!("Need to have Administrator right to create the file");
            return 1;
        }

        let mut generator: Generator<rand::rngs::ThreadRng> =
            match Generator::new(&self.filename, rand::thread_rng(), DEFAULT_MAX_REPEAT) {
                Ok(generator) => generator,
                Err(_) => {
                    println!("Regex expressions are malformed.");

                    return 1;
                }
            };
        let mut buffer: Vec<u8> = vec![];
        generator.generate(&mut buffer).unwrap();
        let fullname: String = match String::from_utf8(buffer) {
            Ok(string) => string,
            Err(_) => {
                println!("Filename contains non-utf8 characters.");

                return 1;
            }
        };

        println!("Create a file on disk");

        let payload: Vec<u8> = match general_purpose::STANDARD.decode(self.magicbyte.as_str()) {
            Ok(decoded) => decoded,
            Err(_) => {
                println!("Could not decode the data.");

                return 1;
            }
        };
        let ret: bool = create_file(&fullname, payload);

        if ret == true {
            if self.remove {
                let sleep_duration: Duration = time::Duration::from_millis(2000);
                thread::sleep(sleep_duration);

                let deleted: bool = delete_file(&fullname);
                if deleted {
                    return 0;
                } else {
                    return 1;
                }
            }
            return 0;
        } else {
            return 1;
        }
    }
}
